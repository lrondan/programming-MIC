<!-- panel_0/templates/panel_0/home.html -->
{% extends "base.html" %}
{% load static %}
{% load utils %}

{% block title %}Inicio | NR DASH {% endblock %}

{% block content %}
{% load static %}

<link rel="icon" type="image/x-icon" href="{% static 'img/logo.ico' %}">

<body class="min-h-screen flex items-center justify-center bg-cover bg-center bg-no-repeat py-12 px-4" 
      style="background-image: url('{% static 'img/backgnd-panel_0.png' %}');  background-attachment: fixed;">

<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
            <i class="fas fa-microchip text-blue-600"></i>
            Mis Dispositivos
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">
            Bienvenido, <strong>{{ user.get_full_name|default:user.username }}</strong>. Aquí tienes tus sensores IoT.
        </p>
    </div>

    {% if dispositivos %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
            {% for d in dispositivos %}
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                
                <!-- Header de la tarjeta -->
                <div class="p-6 border-b dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white text-xl">
                                <i class="fas fa-{{ d.icono|default:'microchip' }}"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
                                    {{ d.nombre }}
                                </h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    Channel: {{ d.thingspeak_channel|default:"Sin configurar" }}
                                </p>
                            </div>
                        </div>
                        <!-- Estado Online/Offline -->
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3 h-3 rounded-full {% if d.estado == 'online' %}bg-green-500 animate-pulse{% else %}bg-red-500{% endif %}"></span>
                            <span class="text-sm font-medium {% if d.estado == 'online' %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                {{ d.estado|capfirst }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Últimos valores -->
                <div class="p-6 space-y-3">
                {% for i in "12345678" %}
                    {% with valor=d|getattr_value:"valor"|add:i label=d|getattr_value:"label"|add:i unidad=d|getattr_value:"unidad"|add:i %}
                        {% if valor is not None %}
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">
                                {{ label|default:"Field " }}{{ i }}
                            </span>
                            <span class="font-mono text-lg font-semibold text-gray-800 dark:text-white">
                                {{ valor|floatformat:2 }} {{ unidad|default:"" }}
                            </span>
                        </div>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
                    
                    {% if d.ultimo_dato %}
                    <div class="text-xs text-gray-500 dark:text-gray-400 pt-2 border-t dark:border-gray-700">
                        Última lectura: {{ d.ultimo_dato|date:"d/m H:i" }}
                    </div>
                    {% endif %}
                </div>

                <!-- Botones de acción -->
                <div class="p-6 pt-0">
                    <div class="flex justify-end gap-2">
                        
                        <!-- Dashboard -->
                        <a href="{% url 'device_detail' d.id %}"
                           class="group flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-sm font-medium rounded-lg shadow hover:shadow-md transform hover:scale-105 transition-all duration-300">
                            <i class="fas fa-tachometer-alt group-hover:animate-pulse"></i>
                            <span>Dashboard</span>
                        </a>

                        <!-- Análisis Estadístico -->
                        <a href="{% url 'analisis' d.id %}"
                           class="group flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white text-sm font-medium rounded-lg shadow hover:shadow-md transform hover:scale-105 transition-all duration-300">
                            <i class="fas fa-chart-bar group-hover:animate-bounce"></i>
                            <span>Análisis</span>
                        </a>
                        <!-- BOTÓN ELIMINAR -->
                        <a href="{% url 'eliminar_dispositivo' d.id %}" 
                            class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm"
                            onclick="return confirm('¿Seguro que quieres eliminar este dispositivo?')">
                            <i class="fas fa-trash"></i>
                            <span>Eliminar</span>
                        </a> 

                        <!-- Deep AI (Análisis Profundo) -->
                        {% if d.lecturas.exists %}
                        <a href="{% url 'deep_analisis' d.id %}"
                           class="group flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-orange-600 to-red-600 text-white text-sm font-medium rounded-lg shadow hover:shadow-md transform hover:scale-105 transition-all duration-300">
                            <i class="fas fa-brain text-lg group-hover:animate-pulse"></i>
                            <span>Deep AI</span>
                        </a>
                
                        {% else %}
                        <button disabled
                                class="flex items-center gap-2 px-3 py-2 bg-gray-400 text-white text-sm font-medium rounded-lg opacity-60 cursor-not-allowed">
                            <i class="fas fa-ban"></i>
                            <span>Sin datos</span>
                        </button>
                        {% endif %}

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Sin dispositivos -->
        <div class="text-center py-16">
            <div class="bg-gray-200 border-2 border-dashed rounded-xl w-24 h-24 mx-auto mb-6 flex items-center justify-center">
                <i class="fas fa-microchip text-4xl text-gray-400"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">
                No tienes dispositivos aún
            </h3>
            <p class="text-gray-500 dark:text-gray-400 mb-6">
                Ve al Admin para agregar tu primer sensor IoT.
            </p>
            {% if user.is_staff %}
            <a href="/admin/panel_0/dispositivo/add/" 
               class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-plus"></i> Agregar Dispositivo
            </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% if user.is_authenticated %}
<!-- Botón flotante -->
<div class="fixed bottom-6 right-6 z-50">
    <button onclick="openModal()" 
            class="w-14 h-14 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full shadow-2xl hover:shadow-3xl transform hover:scale-110 transition-all duration-300 flex items-center justify-center">
        <i class="fas fa-plus text-2xl"></i>
    </button>
</div>

<!-- Modal -->
<!-- BOTÓN QUE VA DIRECTO A /add_device/ -->
<a href="/add_device/" 
   class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full shadow-2xl flex items-center justify-center hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-110 z-50 group">
    <i class="fas fa-plus text-2xl group-hover:rotate-90 transition-transform"></i>
</a>

<!-- JavaScript para abrir/cerrar modal -->
<script>
function openModal() {
    document.getElementById('modal-agregar').showModal();
}
function closeModal() {
    document.getElementById('modal-agregar').close();
}
</script>
{% endif %}
{% endblock %}