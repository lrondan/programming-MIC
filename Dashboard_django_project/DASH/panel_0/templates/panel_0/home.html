<!-- panel_0/templates/panel_0/home.html -->
{% extends "base.html" %}
{% load static %}
{% load utils %}

{% block title %}Inicio | NR DASH {% endblock %}

{% block content %}
{% load static %}
<body class="min-h-screen flex items-center justify-center bg-cover bg-center bg-no-repeat py-12 px-4" 
      style="background-image: url('{% static 'img/backgnd-panel_0.png' %}');  background-attachment: fixed;">

<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
            <i class="fas fa-microchip text-blue-600"></i>
            Mis Dispositivos
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">
            Bienvenido, <strong>{{ user.get_full_name|default:user.username }}</strong>. Aquí tienes tus sensores IoT.
        </p>
    </div>

    {% if dispositivos %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for d in dispositivos %}
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                
                <!-- Header de la tarjeta -->
                <div class="p-6 border-b dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white text-xl">
                                <i class="fas fa-{{ d.icono|default:'microchip' }}"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
                                    {{ d.nombre }}
                                </h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    Channel: {{ d.thingspeak_channel|default:"Sin configurar" }}
                                </p>
                            </div>
                        </div>
                        <!-- Estado Online/Offline -->
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3 h-3 rounded-full {% if d.estado == 'online' %}bg-green-500 animate-pulse{% else %}bg-red-500{% endif %}"></span>
                            <span class="text-sm font-medium {% if d.estado == 'online' %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                {{ d.estado|capfirst }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Últimos valores -->
                <div class="p-6 space-y-3">
                {% for i in "12345678" %}
                    {% with valor=d|getattr_value:"valor"|add:i label=d|getattr_value:"label"|add:i unidad=d|getattr_value:"unidad"|add:i %}
                        {% if valor is not None %}
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">
                                {{ label|default:"Field " }}{{ i }}
                            </span>
                            <span class="font-mono text-lg font-semibold text-gray-800 dark:text-white">
                                {{ valor|floatformat:2 }} {{ unidad|default:"" }}
                            </span>
                        </div>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
                    
                    {% if d.ultimo_dato %}
                    <div class="text-xs text-gray-500 dark:text-gray-400 pt-2 border-t dark:border-gray-700">
                        Última lectura: {{ d.ultimo_dato|date:"d/m H:i" }}
                    </div>
                    {% endif %}
                </div>

                <!-- Botones de acción -->
                <div class="p-6 pt-0">
                    <div class="flex justify-end gap-2">
                        
                        <!-- Dashboard -->
                        <a href="{% url 'device_detail' d.id %}"
                           class="group flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-sm font-medium rounded-lg shadow hover:shadow-md transform hover:scale-105 transition-all duration-300">
                            <i class="fas fa-tachometer-alt group-hover:animate-pulse"></i>
                            <span>Dashboard</span>
                        </a>

                        <!-- Análisis Estadístico -->
                        <a href="{% url 'analisis' d.id %}"
                           class="group flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white text-sm font-medium rounded-lg shadow hover:shadow-md transform hover:scale-105 transition-all duration-300">
                            <i class="fas fa-chart-bar group-hover:animate-bounce"></i>
                            <span>Análisis</span>
                        </a>

                        <!-- Deep AI (Análisis Profundo) -->
                        {% if d.lecturas.exists %}
                        <a href="{% url 'deep_analisis' d.id %}"
                           class="group flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-orange-600 to-red-600 text-white text-sm font-medium rounded-lg shadow hover:shadow-md transform hover:scale-105 transition-all duration-300">
                            <i class="fas fa-brain text-lg group-hover:animate-pulse"></i>
                            <span>Deep AI</span>
                        </a>
                        {% else %}
                        <button disabled
                                class="flex items-center gap-2 px-3 py-2 bg-gray-400 text-white text-sm font-medium rounded-lg opacity-60 cursor-not-allowed">
                            <i class="fas fa-ban"></i>
                            <span>Sin datos</span>
                        </button>
                        {% endif %}

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Sin dispositivos -->
        <div class="text-center py-16">
            <div class="bg-gray-200 border-2 border-dashed rounded-xl w-24 h-24 mx-auto mb-6 flex items-center justify-center">
                <i class="fas fa-microchip text-4xl text-gray-400"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">
                No tienes dispositivos aún
            </h3>
            <p class="text-gray-500 dark:text-gray-400 mb-6">
                Ve al Admin para agregar tu primer sensor IoT.
            </p>
            {% if user.is_staff %}
            <a href="/admin/panel_0/dispositivo/add/" 
               class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-plus"></i> Agregar Dispositivo
            </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% if user.is_authenticated %}
<!-- Botón flotante -->
<div class="fixed bottom-6 right-6 z-50">
    <button onclick="openModal()" 
            class="w-14 h-14 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full shadow-2xl hover:shadow-3xl transform hover:scale-110 transition-all duration-300 flex items-center justify-center">
        <i class="fas fa-plus text-2xl"></i>
    </button>
</div>

<!-- Modal -->
<dialog id="modal-agregar" class="modal backdrop:bg-black/50">
    <div class="modal-box w-11/12 max-w-2xl bg-white dark:bg-gray-800 rounded-xl p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Agregar Nuevo Dispositivo</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- FORMULARIO EN EL MODAL -->
        <form method="post" action="{% url 'agregar_dispositivo' %}" class="space-y-4">
            {% csrf_token %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre</label>
                    <input type="text" name="nombre" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" placeholder="ESP32 Sala">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Channel ID (ThingSpeak)</label>
                    <input type="number" name="thingspeak_channel" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" placeholder="1234567">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ícono</label>
                    <select name="icono" class="w-full px-3 py-2 border rounded-lg">
                        <option value="microchip">Microchip</option>
                        <option value="thermometer-half">Temperatura</option>
                        <option value="tint">Humedad</option>
                        <option value="wind">Viento</option>
                        <option value="lightbulb">Luz</option>
                        <option value="bolt">Voltaje</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Campo 1</label>
                    <input type="text" name="label1" class="w-full px-3 py-2 border rounded-lg" placeholder="Temperatura">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Unidad 1</label>
                    <input type="text" name="unidad1" class="w-full px-3 py-2 border rounded-lg" placeholder="°C">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Campo 2</label>
                    <input type="text" name="label2" class="w-full px-3 py-2 border rounded-lg" placeholder="Humedad">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Unidad 2</label>
                    <input type="text" name="unidad2" class="w-full px-3 py-2 border rounded-lg" placeholder="%">
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeModal()"
                        class="px-5 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                    Cancelar
                </button>
                <button type="submit"
                        class="px-5 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition transform hover:scale-105">
                    <i class="fas fa-save mr-2"></i> Guardar
                </button>
            </div>
        </form>
    </div>
</dialog>

<!-- JavaScript para abrir/cerrar modal -->
<script>
function openModal() {
    document.getElementById('modal-agregar').showModal();
}
function closeModal() {
    document.getElementById('modal-agregar').close();
}
</script>
{% endif %}
{% endblock %}