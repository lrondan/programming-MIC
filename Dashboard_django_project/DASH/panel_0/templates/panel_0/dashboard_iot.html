{% extends "base.html" %}

{% block title %}Inicio | DASH IoT{% endblock %}

{% block content %}
{% load static %}
<!-- panel_0/templates/panel_0/dashboard_iot.html -->
<!DOCTYPE html>
<html>
<head>
    <title>DASH | ESP32 Grid</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --online: #28a745; --warning: #ffc107; --offline: #dc3545;
            --card-bg: #ffffff; --text: #2c3e50; --border: 6px;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f6f9; color: var(--text); }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; }

        h1 { text-align: center; color: var(--text); margin: 0 0 10px; }
        .subtitle { text-align: center; color: #777; font-size: 0.9rem; margin-bottom: 30px; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        .chart-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: var(--border);
            background: var(--online);
        }
        .warning::before { background: var(--warning); }
        .offline::before { background: var(--offline); }

        .chart-header {
            padding: 15px 20px 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chart-title { font-weight: 600; color: #444; font-size: 1rem; }
        .chart-value { font-weight: bold; color: var(--text); font-size: 1.1rem; }
        .chart-unit { color: #777; font-size: 0.9rem; margin-left: 4px; }

        .chart-iframe { width: 100%; height: 260px; border: none; }

        .device-summary {
            grid-column: 1 / -1;
            background: white; padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center; margin-bottom: 20px;
        }
        .device-summary .icon { font-size: 3rem; margin-bottom: 10px; }
        .status { display: inline-flex; align-items: center; gap: 6px; font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; }
        .online .status { background: #d4edda; color: #155724; }
        .pulse { width: 8px; height: 8px; background: currentColor; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

        .footer { text-align: center; margin: 40px 0; color: #777; font-size: 0.9rem; }
        .no-data { grid-column: 1/-1; text-align: center; color: #999; font-style: italic; padding: 40px; }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center bg-cover bg-center bg-no-repeat py-12 px-4" 
      style="background-image: url('{% static 'img/backgnd-panel_0.png' %}');  background-attachment: fixed;">
    <div class="container">

        {% for data in dispositivos_data %}
        {% with d=data.dispositivo %}
        <div class="device-summary {{ d.estado }}">
            <div class="icon"><i class="fas fa-{{ d.icono|default:'microchip' }}"></i></div>
            <h2 style="margin: 10px 0; font-size: 1.6rem;">{{ d.nombre }}</h2>
            {% if data.campos %}
            <p style="margin: 8px 0; font-size: 1.8rem; font-weight: bold;">
                {{ data.campos.0.valor|floatformat:1 }} {{ data.campos.0.unidad }}
            </p>
            {% endif %}
            <div class="status">
                {% if d.estado == 'online' %}<span class="pulse"></span>{% endif %}
                {{ d.get_estado_display }}
            </div>
            {% if d.ultimo_dato %}
            <small style="color:#999; display:block; margin-top:8px;">
                Última lectura: {{ d.ultimo_dato|date:"d/m H:i:s" }}
            </small>
            {% endif %}
        </div>

        <div class="charts-grid">
            {% for campo in data.campos %}
            <div class="chart-card {{ d.estado }}">
                <div class="chart-header">
                    <div class="chart-title">{{ campo.label }}</div>
                    <div>
                        <span class="chart-value">{{ campo.valor|floatformat:1 }}</span>
                        <span class="chart-unit">{{ campo.unidad }}</span>
                    </div>
                </div>
                <iframe class="chart-iframe"
                    src="https://thingspeak.mathworks.com/channels/{{ d.thingspeak_channel }}/charts/{{ campo.num }}?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&type=line&update=15">
                </iframe>
                <div class="flex justify-center mt-6">
                    <a href="{% url 'analisis' d.id %}" class= "inline-flex items-center gap-3 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-full shadow-md hover:shadow-2xl transform hover:scale-110 transition-all duration-300 hover:from-purple-700 hover:to-pink-700">
                        <i class="fas fa-analytics text-xl"></i>
                        <span class="text-lg">Ver Análisis Completo</span>
                    </a>
                </div>

            </div>
            {% endfor %}
        </div>
        {% endwith %}
        {% empty %}
        <p class="no-data">No hay dispositivos con Channel ID.</p>
        {% endfor %}
        </div>

        <div class="footer">
            <i class="fas fa-sync"></i> Gráficos se actualizan cada 15 segundos • 
            <span id="clock"></span>
        </div>
    </div>
    {% if error %}
    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px;">
    <strong>Error:</strong> {{ error }} <br>
    <small>Ve al Admin y asegúrate de que el Channel ID esté guardado.</small>
    </div>
    {% endif %}

    <script>
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('es-ES');
        }, 1000);
    </script>
</body>
</html>

{% endblock %}